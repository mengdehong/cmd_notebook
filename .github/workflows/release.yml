name: Release

permissions:
  contents: write

on:
  push:
    tags:
      - "v*"
  workflow_dispatch:

jobs:
  build:
    name: Build ${{ matrix.platform }}
    runs-on: ${{ matrix.platform }}
    strategy:
      fail-fast: false
      matrix:
        platform:
          - macos-latest
          - windows-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Rust toolchain
        uses: dtolnay/rust-toolchain@stable

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm

      - name: Install frontend dependencies
        run: npm ci

      - name: Build and bundle with Tauri
        uses: tauri-apps/tauri-action@v0
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: tauri-bundles-${{ matrix.platform }}
          path: |
            src-tauri/target/release/bundle/**

  publish:
    name: Publish Release
    runs-on: ubuntu-latest
    needs: build
    steps:
      - name: Download build artifacts
        uses: actions/download-artifact@v4
        with:
          pattern: tauri-bundles-*
          path: release-artifacts
          merge-multiple: true

      - name: Archive app bundles
        shell: bash
        run: |
          set -euo pipefail
          find release-artifacts -type d -name "*.app" -print0 | while IFS= read -r -d '' dir; do
            parent="$(dirname "$dir")"
            base="$(basename "$dir")"
            tarball="${parent}/${base}.tar.gz"
            if [ ! -f "$tarball" ]; then
              tar -czf "$tarball" -C "$parent" "$base"
            fi
          done

      - name: Collect artifact files
        id: bundle_paths
        shell: bash
        run: |
          set -euo pipefail
          mapfile -d '' files < <(find release-artifacts -type f \( -iname '*.zip' -o -iname '*.tar.gz' -o -iname '*.dmg' -o -iname '*.msi' -o -iname '*.exe' -o -iname '*.appimage' -o -iname '*.pkg' -o -iname '*.deb' -o -iname '*.rpm' \) -print0)
          if [ "${#files[@]}" -eq 0 ]; then
            echo "No bundle files found in release-artifacts" >&2
            exit 1
          fi
          joined=$(printf "%s," "${files[@]}")
          joined=${joined%,}
          echo "files=$joined" >> "$GITHUB_OUTPUT"

      - name: Create Release and Upload Assets
        uses: ncipollo/release-action@v1
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          tag: ${{ github.ref_name }}
          artifacts: ${{ steps.bundle_paths.outputs.files }}
          artifactErrorsFailBuild: true
          replacesArtifacts: false
          allowUpdates: true
          generateReleaseNotes: false
          immutableCreate: false
          makeLatest: legacy
          omitBody: false
          omitBodyDuringUpdate: false
          omitDraftDuringUpdate: false
          omitName: false
          omitNameDuringUpdate: false
          omitPrereleaseDuringUpdate: false
          removeArtifacts: false
          skipIfReleaseExists: false
          updateOnlyUnreleased: false
